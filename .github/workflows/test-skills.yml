name: Skill Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      affected_tests: ${{ steps.affected.outputs.test_files }}
      has_affected: ${{ steps.affected.outputs.has_tests }}
      run_full: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect affected skills
        id: affected
        run: |
          AFFECTED=$(node -e "
            import('./tests/harness/affected.js').then(m => {
              const files = m.getAffectedTestFiles();
              console.log(files.join(' '));
            }).catch(() => console.log(''));
          ")
          echo "test_files=$AFFECTED" >> $GITHUB_OUTPUT
          echo "has_tests=$( [ -n \"$AFFECTED\" ] && echo true || echo false )" >> $GITHUB_OUTPUT

  test-affected:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_affected == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run affected skill tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node --test \
            --test-reporter spec --test-reporter-destination stdout \
            --test-reporter junit --test-reporter-destination junit.xml \
            ${{ needs.detect-changes.outputs.affected_tests }}

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'junit.xml'
          fail_on_failure: true
          include_passed: false
          check_name: 'Affected Skill Tests'

  test-full:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_full == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run all skill tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npm run test:skills

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'junit.xml'
          fail_on_failure: true
          include_passed: false
          check_name: 'Full Skill Tests'
