---
phase: 06-pr-review-workflow-skill-agents
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - tests/skills/reviewing-pull-requests.test.js
  - README.md
autonomous: true

must_haves:
  truths:
    - "PR review skill has test coverage"
    - "README documents PR review workflow"
    - "Test follows existing test patterns"
  artifacts:
    - path: "tests/skills/reviewing-pull-requests.test.js"
      provides: "Test coverage for PR review skill"
      min_lines: 40
    - path: "README.md"
      provides: "Documentation for PR review feature"
      contains: "PR Review"
  key_links:
    - from: "tests/skills/reviewing-pull-requests.test.js"
      to: "skills/kata-reviewing-pull-requests/SKILL.md"
      via: "test fixture"
      pattern: "kata-reviewing-pull-requests"
---

<objective>
Add test coverage for PR review skill and document the feature in README.

Purpose: Tests ensure the skill triggers correctly on natural language prompts. README documentation helps users discover and use the PR review workflow.

Output: Test file following existing patterns, README with PR review section.
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/README.md
@README.md
@skills/kata-reviewing-pull-requests/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR review skill test</name>
  <files>tests/skills/reviewing-pull-requests.test.js</files>
  <action>
    Create test file following existing patterns in tests/skills/.

    Test structure:
    1. Import test harness utilities
    2. Set up isolated test directory with fixtures
    3. Install kata-reviewing-pull-requests skill
    4. Install review agents (kata-code-reviewer.md, etc.)
    5. Test natural language trigger: "review my PR" or "run code review"

    Key patterns from tests/README.md:
    - Use `mkdtempSync` for isolated test directory
    - Copy fixtures/kata-project to test directory
    - Install skill to testDir/.claude/skills/
    - Install agents to testDir/.claude/agents/
    - Use `invokeClaude()` with appropriate budget
    - Assert `num_turns > 1` (skill ran, not ad-hoc answer)
    - Assert no error

    Test cases:
    1. `it('triggers on "review my PR" prompt')` — verifies skill triggers
    2. `it('triggers on "run code review" prompt')` — alternative phrasing

    Note: This is a quick trigger test ($0.50 budget), not a full workflow test.
    The skill spawns multiple agents which would be expensive to fully test.
    We verify the skill activates; agent behavior is tested elsewhere.

    Template:
    ```javascript
    import { describe, it, beforeEach, afterEach } from 'node:test';
    import { mkdtempSync, rmSync, cpSync, existsSync } from 'node:fs';
    import { tmpdir } from 'node:os';
    import { join, dirname } from 'node:path';
    import { fileURLToPath } from 'node:url';

    import { invokeClaude } from '../harness/claude-cli.js';
    import { assertSkillInvoked, assertNoError } from '../harness/assertions.js';

    const __dirname = dirname(fileURLToPath(import.meta.url));
    const FIXTURES_DIR = join(__dirname, '..', 'fixtures', 'kata-project');
    const KATA_ROOT = join(__dirname, '..', '..');

    describe('kata-reviewing-pull-requests', () => {
      let testDir;

      beforeEach(() => {
        testDir = mkdtempSync(join(tmpdir(), 'kata-test-'));
        cpSync(FIXTURES_DIR, testDir, { recursive: true });

        // Install skill
        const skillSource = join(KATA_ROOT, 'skills', 'kata-reviewing-pull-requests');
        const skillDest = join(testDir, '.claude', 'skills', 'kata-reviewing-pull-requests');
        cpSync(skillSource, skillDest, { recursive: true });

        // Install review agents
        const agents = [
          'kata-code-reviewer.md',
          'kata-code-simplifier.md',
          'kata-comment-analyzer.md',
          'kata-pr-test-analyzer.md',
          'kata-failure-finder.md',
          'kata-type-design-analyzer.md'
        ];
        for (const agent of agents) {
          cpSync(
            join(KATA_ROOT, 'agents', agent),
            join(testDir, '.claude', 'agents', agent)
          );
        }
      });

      afterEach(() => {
        if (testDir && existsSync(testDir)) {
          rmSync(testDir, { recursive: true, force: true });
        }
      });

      it('triggers on "review my PR" prompt', async () => {
        const result = await invokeClaude('review my PR', {
          cwd: testDir,
          maxBudget: 0.50,
          timeout: 60000
        });

        assertNoError(result);
        assertSkillInvoked(result);
      });

      it('triggers on "run code review" prompt', async () => {
        const result = await invokeClaude('run code review', {
          cwd: testDir,
          maxBudget: 0.50,
          timeout: 60000
        });

        assertNoError(result);
        assertSkillInvoked(result);
      });
    });
    ```
  </action>
  <verify>
    - File exists at tests/skills/reviewing-pull-requests.test.js
    - File imports test harness utilities
    - File has beforeEach/afterEach for test isolation
    - File has at least 2 test cases
    - File installs skill and agents
  </verify>
  <done>Test file created following existing patterns with skill trigger verification.</done>
</task>

<task type="auto">
  <name>Task 2: Add PR review section to README</name>
  <files>README.md</files>
  <action>
    Add a "PR Review" section to README.md documenting the feature.

    Location: After "Quick Mode" section and before "Why It Works" section.

    Content:
    ```markdown
    ### PR Review

    ```
    "Review my PR"
    ```
    <sub>or `/kata:reviewing-pull-requests`</sub>

    **Automated code quality analysis using specialized review agents.**

    The PR review workflow runs multiple specialized agents, each focusing on a different aspect:

    | Agent                  | Focus                                      |
    | ---------------------- | ------------------------------------------ |
    | `code-reviewer`        | General code quality, CLAUDE.md compliance |
    | `comment-analyzer`     | Comment accuracy and documentation         |
    | `pr-test-analyzer`     | Test coverage and quality                  |
    | `failure-finder`       | Error handling and silent failures         |
    | `type-design-analyzer` | Type design and invariants                 |
    | `code-simplifier`      | Code clarity and maintainability           |

    **Usage:**

    ```
    "Review my PR"                    # Full review (all agents)
    "Run code review"                 # Quick review (code agent only)
    "Review tests and error handling" # Specific aspects
    ```

    **Integration with phase execution:**

    When `pr_workflow: true`, phase completion offers automated review after marking the PR ready:

    1. Phase completes all plans
    2. PR marked ready via `gh pr ready`
    3. Optional: Run automated review
    4. Review summary shown with phase completion

    Review is always optional and non-blocking — findings are informational for the subsequent human review.

    **Creates:** Review summary in phase completion output
    ```

    Ensure the section follows the existing README formatting style:
    - ### heading for the section title
    - Code block for the voice command
    - <sub> for the slash command alternative
    - Bold for key points
    - Table for agent list
  </action>
  <verify>
    - README.md contains "### PR Review" section
    - Section includes agent table
    - Section includes usage examples
    - Section includes phase execution integration note
  </verify>
  <done>README updated with PR review documentation matching existing style.</done>
</task>

</tasks>

<verification>
- `ls tests/skills/reviewing-pull-requests.test.js` — file exists
- `grep "kata-reviewing-pull-requests" tests/skills/reviewing-pull-requests.test.js` — skill installed
- `grep "### PR Review" README.md` — section header present
- `grep "code-reviewer" README.md` — agent table present
</verification>

<success_criteria>
- [ ] Test file created at tests/skills/reviewing-pull-requests.test.js
- [ ] Test installs skill and agents
- [ ] Test has at least 2 trigger test cases
- [ ] README has PR Review section with agent table
- [ ] README documents phase execution integration
</success_criteria>

<output>
After completion, create `.planning/phases/06-pr-review-workflow-skill-agents/06-03-SUMMARY.md`
</output>
