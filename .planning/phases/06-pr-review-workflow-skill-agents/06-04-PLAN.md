---
phase: 06-pr-review-workflow-skill-agents
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-executing-phases/SKILL.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can create backlog todos for review suggestions"
    - "Merge PR is primary action before next phase when pr_workflow enabled"
  artifacts:
    - path: "skills/kata-executing-phases/SKILL.md"
      provides: "Updated offer_next and step 10.6 with merge prompt and todo prompt"
      contains: "Merge PR"
  key_links:
    - from: "step 10.6"
      to: "offer_next Route A"
      via: "REVIEW_SUMMARY passed through"
      pattern: "REVIEW_SUMMARY"
---

<objective>
Fix two UAT gaps in kata-executing-phases PR review workflow integration.

Purpose: Complete Phase 6 by addressing user experience gaps discovered during acceptance testing.

Output: Updated SKILL.md with backlog todo prompt and merge-first action flow.
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-pr-review-workflow-skill-agents/06-UAT.md
@skills/kata-executing-phases/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backlog todo prompt after PR review</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
    In Step 10.6 (Run PR Review), after displaying review summary, add a conditional prompt when suggestions exist:

    After storing REVIEW_SUMMARY (around line 393):

    ```
    **If REVIEW_SUMMARY contains suggestions (non-critical findings):**

    Use AskUserQuestion:
    - header: "Review Suggestions"
    - question: "Create backlog todos for the {N} suggestions from code review?"
    - options:
      - "Yes, create todos" — Create todos using `/kata:add-todo` for each suggestion, then continue
      - "No, skip" — Continue without creating todos

    **If user chooses "Yes, create todos":**
    For each suggestion in REVIEW_SUMMARY:
    - Extract suggestion text
    - Create todo with appropriate tag (e.g., "refactor", "perf", "docs")
    - Log: "Created todo: {suggestion summary}"

    Store TODOS_CREATED count for offer_next output.
    ```

    This gives users an actionable way to capture suggestions rather than just displaying them.
  </action>
  <verify>
    - Step 10.6 contains "Review Suggestions" AskUserQuestion
    - Options include "Yes, create todos" and "No, skip"
    - TODOS_CREATED variable stored for later use
  </verify>
  <done>Users prompted to create backlog todos for review suggestions.</done>
</task>

<task type="auto">
  <name>Task 2: Add merge prompt to offer_next Route A</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
    Update Route A in `<offer_next>` (around line 411-441) to prioritize merging PR before next phase:

    Replace the current Route A output with:

    ```markdown
    **Route A: Phase verified, more phases remain**

    {If pr_workflow: Use AskUserQuestion first}

    **If PR_WORKFLOW=true:**
    Use AskUserQuestion:
    - header: "PR Ready for Merge"
    - question: "PR #{pr_number} is ready. Merge before continuing to next phase?"
    - options:
      - "Yes, merge now" — Run `gh pr merge --squash --delete-branch`, then show next phase
      - "No, review first" — Show PR URL and next phase as current output does
      - "Skip to next phase" — Continue without merge prompt (current behavior)

    **If user chooses "Yes, merge now":**
    ```bash
    gh pr merge "$PR_NUMBER" --squash --delete-branch
    echo "Merged PR #${PR_NUMBER}"
    git checkout main && git pull
    ```
    Then display standard completion with next phase.

    **If user chooses "No, review first" or "Skip":**
    Display current Route A output (PR ready for review, then next phase).

    The markdown output template remains mostly the same, but add merge status line:

    {If PR_WORKFLOW and PR merged: `PR: #{pr_number} — merged`}
    {If PR_WORKFLOW and PR not merged: `PR: #{pr_number} ({pr_url}) — ready for review`}
    {If TODOS_CREATED: `Backlog: {N} todos created from review suggestions`}
    ```

    This ensures merge is the primary action when pr_workflow enabled, not an afterthought.
  </action>
  <verify>
    - Route A contains AskUserQuestion with "PR Ready for Merge" header
    - Options include "Yes, merge now", "No, review first", "Skip to next phase"
    - Merge command uses `--squash --delete-branch`
    - Output template shows merge status line
  </verify>
  <done>Merge PR is primary action before suggesting next phase.</done>
</task>

</tasks>

<verification>
- `grep -n "PR Ready for Merge" skills/kata-executing-phases/SKILL.md` — merge prompt exists
- `grep -n "Review Suggestions" skills/kata-executing-phases/SKILL.md` — todo prompt exists
- `grep -n "Yes, merge now" skills/kata-executing-phases/SKILL.md` — merge option exists
- `grep -n "Yes, create todos" skills/kata-executing-phases/SKILL.md` — todo option exists
</verification>

<success_criteria>
- [ ] Step 10.6 prompts to create backlog todos for review suggestions
- [ ] Route A offers merge as primary action when pr_workflow enabled
- [ ] Merge uses --squash --delete-branch flags
- [ ] Output shows merge status and todos created count
</success_criteria>

<output>
After completion, create `.planning/phases/06-pr-review-workflow-skill-agents/06-04-SUMMARY.md`
</output>
