---
phase: 02.1-skill-resource-restructure
plan: 04
type: execute
wave: 3
depends_on: ["02.1-02", "02.1-03"]
files_modified:
  - scripts/build.js
autonomous: true

must_haves:
  truths:
    - "Build system no longer copies kata/ directory to distributions"
    - "Build system no longer transforms @~/.claude/kata/ paths"
    - "Build validation no longer checks for kata/ directory"
    - "Plugin and npm builds still produce valid distributions"
  artifacts:
    - path: "scripts/build.js"
      provides: "Simplified build system without kata/ handling"
      contains: "COMMON_INCLUDES"
  key_links: []
---

<objective>
Update build system to remove kata/ directory handling.

Purpose: Since skills and agents now bundle their own resources with relative paths, the shared kata/ directory is no longer needed in distributions and the path transformation logic is obsolete.

Output: Simplified build.js that copies skills, agents, commands, hooks without kata/ or path transforms.
</objective>

<context>
@.planning/phases/v1.0.6-02.1-skill-resource-restructure/02.1-RESEARCH.md
@scripts/build.js

**Current build behavior (to remove):**
1. COMMON_INCLUDES contains 'kata' - copies kata/ to dist
2. transformPluginPaths() replaces @~/.claude/kata/ with @./
3. validateBuild() checks for kata directory existence
4. validateBuild() scans for untransformed @~/.claude/ paths

**Target build behavior:**
1. COMMON_INCLUDES: ['commands/kata', 'skills', 'agents', 'hooks', 'CHANGELOG.md']
2. No path transformation needed (relative paths work everywhere)
3. Validation checks for skills, agents, commands - not kata
4. Validation verifies no @~/.claude/ paths remain (safety check still valid)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove kata/ from COMMON_INCLUDES and simplify build</name>
  <files>scripts/build.js</files>
  <action>
    Update scripts/build.js:

    1. **Remove 'kata' from COMMON_INCLUDES** (line ~47):
       ```javascript
       const COMMON_INCLUDES = [
         'commands/kata',
         'skills',
         'agents',
         'hooks',
         'CHANGELOG.md',
       ];
       ```

    2. **Remove transformPluginPaths function** (lines ~205-207):
       Delete or comment out:
       ```javascript
       function transformPluginPaths(content) {
         return content.replace(/@~\/\.claude\/kata\//g, '@./');
       }
       ```

    3. **Update buildPlugin() to not use transform** (line ~282):
       Change:
       ```javascript
       if (copyPath(item, dest, transformPluginPaths, shouldExcludeFromPlugin)) {
       ```
       To:
       ```javascript
       if (copyPath(item, dest, null, shouldExcludeFromPlugin)) {
       ```

    4. **Update validateBuild() required directories** (lines ~224-225):
       Change:
       ```javascript
       const requiredDirs = ['kata', 'agents', 'skills'];
       ```
       To:
       ```javascript
       const requiredDirs = ['agents', 'skills'];
       ```

    5. **Keep the @~/.claude/ path check** - this is still valid as a safety net to catch any missed references.
  </action>
  <verify>
    ```bash
    # Build both targets and verify success
    node scripts/build.js all

    # Verify kata/ is not in dist
    ls dist/plugin/kata 2>&1 || echo "kata/ not in plugin dist (expected)"
    ls dist/npm/kata 2>&1 || echo "kata/ not in npm dist (expected)"

    # Verify skills and agents are present
    ls dist/plugin/skills/
    ls dist/plugin/agents/
    ```
  </verify>
  <done>Build system updated: kata/ removed from COMMON_INCLUDES, path transformation removed, validation updated.</done>
</task>

<task type="auto">
  <name>Task 2: Verify no @~/.claude/ references in dist outputs</name>
  <files></files>
  <action>
    After build, verify no old-style absolute paths remain in the distribution:

    ```bash
    # Check plugin distribution
    grep -rn "@~/.claude/" dist/plugin/ || echo "No @~/.claude/ refs in plugin dist"

    # Check npm distribution
    grep -rn "@~/.claude/" dist/npm/ || echo "No @~/.claude/ refs in npm dist"
    ```

    If any matches found, they indicate files that weren't updated in Plans 02/03.
  </action>
  <verify>
    ```bash
    grep -rn "@~/.claude/" dist/plugin/ | wc -l
    grep -rn "@~/.claude/" dist/npm/ | wc -l
    ```
    Both should return 0.
  </verify>
  <done>No @~/.claude/ references in either distribution.</done>
</task>

</tasks>

<verification>
- Build completes successfully for both plugin and npm targets
- dist/plugin/ and dist/npm/ do not contain kata/ directory
- No @~/.claude/ references in distribution files
- skills/ and agents/ directories present in both distributions
</verification>

<success_criteria>
- [ ] COMMON_INCLUDES no longer contains 'kata'
- [ ] transformPluginPaths function removed or unused
- [ ] validateBuild checks for skills, agents (not kata)
- [ ] `node scripts/build.js all` succeeds
- [ ] No kata/ directory in dist/plugin/ or dist/npm/
- [ ] No @~/.claude/ references in distributions
</success_criteria>

<output>
After completion, create `.planning/phases/v1.0.6-02.1-skill-resource-restructure/02.1-04-SUMMARY.md`
</output>
