# Phase 2.1: Skill-Centric Resource Restructure - Research

**Researched:** 2026-01-24
**Domain:** Plugin architecture, skill distribution, Claude Code standards
**Confidence:** HIGH

## Summary

This research investigates how to restructure Kata from its current centralized `kata/` directory (containing shared templates, workflows, and references) to a skill-centric architecture where each skill contains all resources it needs within its own `references/` subdirectory.

The current architecture uses a shared `kata/` directory with ~55 resource files referenced via `@~/.claude/kata/...` paths. Build.js transforms these paths for plugin distribution (`@./kata/`). This creates coupling between skills and shared resources that violates Claude Code plugin standards and prevents independent skill distribution.

**Primary recommendation:** Move all resources into the skills that use them, accepting duplication as the cost of independence. Skills should be fully self-contained with their own `references/` subdirectories.

## Standard Stack

### Current Architecture (What Exists)

| Directory | File Count | Purpose | Referenced By |
|-----------|------------|---------|---------------|
| `kata/templates/` | 22 files + 2 subdirs | Output format templates | Skills, agents |
| `kata/workflows/` | 12 files | Process logic | Skills |
| `kata/references/` | 9 files | Deep-dive documentation | Skills, workflows |

### Target Architecture (Standards-Compliant)

| Pattern | Structure | Purpose |
|---------|-----------|---------|
| Self-contained skill | `skills/kata-X/SKILL.md` + `skills/kata-X/references/` | Skill + all its resources |
| No shared kata/ | Remove `kata/templates/`, `kata/workflows/`, `kata/references/` | Eliminate cross-skill coupling |
| Relative references | `@./references/X.md` within skill | Load from skill's own directory |

### Claude Code Plugin Standards

Per [official documentation](https://code.claude.com/docs/en/plugin-marketplaces):

> "When users install a plugin, Claude Code copies the plugin directory to a cache location. This means plugins can't reference files outside their directory using paths like `../shared-utils`, because those files won't be copied."

**Key constraints:**
- Skills are copied to cache in isolation
- Cross-directory references (`../`) are not allowed
- Each skill must be independently installable
- `SKILL.md` should be under 500 lines (move details to `references/`)

## Architecture Patterns

### Current Dependency Map

Skills with external `kata/` dependencies:

| Skill | kata/references/ | kata/workflows/ | kata/templates/ |
|-------|------------------|-----------------|-----------------|
| kata-executing-phases | ui-brand.md, planning-config.md | phase-execute.md | - |
| kata-starting-projects | questioning.md, ui-brand.md | - | project.md, requirements.md |
| kata-starting-milestones | questioning.md, ui-brand.md | - | project.md, requirements.md |
| kata-resuming-work | - | resume-project.md | - |
| kata-verifying-work | - | verify-work.md | UAT.md |
| kata-discussing-phases | - | phase-discuss.md | context.md |
| kata-completing-milestones | - | milestone-complete.md | milestone-archive.md |
| kata-mapping-codebases | - | project-analyze.md | - |
| kata-listing-phase-assumptions | - | phase-assumptions.md | - |
| kata-planning-phases | ui-brand.md | - | - |

### Recommended Skill Structure

```
skills/
├── kata-executing-phases/
│   ├── SKILL.md                    # Main skill (orchestrator)
│   └── references/
│       ├── ui-brand.md             # Copied from kata/references/
│       ├── planning-config.md      # Copied from kata/references/
│       └── phase-execute.md        # Copied from kata/workflows/
├── kata-starting-projects/
│   ├── SKILL.md
│   └── references/
│       ├── questioning.md
│       ├── ui-brand.md
│       ├── project-template.md     # Renamed from templates/project.md
│       └── requirements-template.md
└── ...
```

### Path Resolution After Restructure

| Before (Source) | After (Source) | Build Transform |
|-----------------|----------------|-----------------|
| `@~/.claude/kata/references/ui-brand.md` | `@./references/ui-brand.md` | No transform needed |
| `@~/.claude/kata/workflows/phase-execute.md` | `@./references/phase-execute.md` | No transform needed |
| `@~/.claude/kata/templates/project.md` | `@./references/project-template.md` | No transform needed |

**Key insight:** Relative paths within a skill directory (`@./references/`) work identically in source, NPM, and plugin distributions without transformation.

### Agent Dependencies

Agents (`agents/*.md`) also reference `kata/` resources:

| Agent | References |
|-------|------------|
| kata-executor | checkpoints.md, summary.md template |
| kata-planner | execute-plan.md, summary.md |

**Decision needed:** Should agents:
1. Remain centralized with their own `references/` subdirectory?
2. Be merged into their spawning skills?
3. Have resources duplicated across multiple locations?

**Recommendation:** Keep agents centralized but move their resources into `agents/references/`. Agents are subagent definitions, not user-facing skills.

## Don't Hand-Roll

Problems with existing solutions that should be preserved:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Path transformation | Custom regex per distribution | Relative paths only | Plugin caching makes absolute paths fail |
| Skill sharing | Monorepo with cross-refs | Duplicate files | Plugin isolation requirement |
| Template loading | Runtime file fetch | Inline or @-reference | @ system is static parser |

**Key insight from CHANGELOG:**
> "Claude's `@` reference system is a static file path parser that cannot substitute variables. Restored canonical `@~/.claude/kata/` paths which `build.js` transforms correctly."

With skill-local resources, no path transformation is needed at all.

## Common Pitfalls

### Pitfall 1: Variable Path References
**What goes wrong:** Using `@$VARIABLE/path.md` expecting substitution
**Why it happens:** Developers assume @ works like shell expansion
**How to avoid:** Only use literal paths; prefer relative paths within skill
**Warning signs:** `$KATA_BASE`, `${VAR}` in @ references

### Pitfall 2: Cross-Skill Dependencies
**What goes wrong:** Skill A references `../skill-B/references/shared.md`
**Why it happens:** DRY instinct to avoid duplication
**How to avoid:** Accept duplication; each skill self-contained
**Warning signs:** `../` in any path

### Pitfall 3: Shared Template Updates
**What goes wrong:** Updating a template requires changes across 10 skills
**Why it happens:** Duplication creates maintenance burden
**How to avoid:** Design templates for stability; version within skills
**Warning signs:** Frequent template changes affecting many skills

### Pitfall 4: Build System Complexity
**What goes wrong:** Complex transform rules for different distribution targets
**Why it happens:** Trying to maintain shared resources across contexts
**How to avoid:** Eliminate shared resources; relative paths work everywhere
**Warning signs:** Multiple regex transforms in build.js

## Code Examples

### Current Pattern (To Change)

```markdown
<!-- In skills/kata-executing-phases/SKILL.md -->
<execution_context>
@~/.claude/kata/references/ui-brand.md
@~/.claude/kata/references/planning-config.md
@~/.claude/kata/workflows/phase-execute.md
</execution_context>
```

### Target Pattern (Self-Contained)

```markdown
<!-- In skills/kata-executing-phases/SKILL.md -->
<execution_context>
@./references/ui-brand.md
@./references/planning-config.md
@./references/phase-execute.md
</execution_context>
```

```
skills/kata-executing-phases/
├── SKILL.md
└── references/
    ├── ui-brand.md           # Previously kata/references/
    ├── planning-config.md    # Previously kata/references/
    └── phase-execute.md      # Previously kata/workflows/
```

### NPX-Style Distribution Reference

From [agent-skill-npm-boilerplate](https://github.com/neovateai/agent-skill-npm-boilerplate):

```
skill-name/
├── package.json              # npm metadata
├── SKILL.md                  # Main skill definition
├── .claude-skill.json        # Installation metadata
├── install-skill.js          # Auto-run during npm install
├── reference.md              # Optional detailed docs
├── examples.md               # Optional usage examples
└── scripts/                  # Utility scripts
```

**Key pattern:** All resources bundled with the skill package itself.

## State of the Art

| Old Approach | Current Approach | Impact |
|--------------|------------------|--------|
| Shared `kata/` directory | Self-contained skills | Each skill independently distributable |
| `@~/.claude/kata/` paths | `@./references/` paths | No build transform needed |
| Central templates | Per-skill templates | Duplication but independence |
| Complex build.js transforms | Simpler copy operations | Reduced build complexity |

**Industry trend:** The [Agent Skills standard](https://agentskills.io) and Claude Code plugin system both favor self-contained, independently distributable skills over shared resources.

## Migration Strategy

### Phase 1: Identify Dependencies
- Map every `@~/.claude/kata/` reference in skills
- Identify which resources are shared across skills
- Document duplication requirements

### Phase 2: Copy Resources Into Skills
- For each skill with external dependencies:
  - Create `references/` subdirectory
  - Copy required files from `kata/` into skill's `references/`
  - Update `@` references to relative paths

### Phase 3: Update Agents
- Create `agents/references/` directory
- Move agent-specific resources there
- Update agent files to use relative references

### Phase 4: Update Build System
- Remove path transformation logic
- Simplify COMMON_INCLUDES (remove `kata`)
- Update validation to check for no absolute `kata/` references

### Phase 5: Remove Shared Resources
- After all skills updated, remove `kata/templates/`, `kata/workflows/`, `kata/references/`
- Keep only `kata/bin/` if needed for install scripts

## Resource Duplication Matrix

Resources that will be duplicated across multiple skills:

| Resource | Used By | Copies Needed |
|----------|---------|---------------|
| ui-brand.md | executing-phases, planning-phases, starting-projects, starting-milestones | 4 |
| questioning.md | starting-projects, starting-milestones | 2 |
| project.md template | starting-projects, starting-milestones | 2 |
| requirements.md template | starting-projects, starting-milestones | 2 |

**Total duplication:** ~10 file copies across all skills

**Mitigation:** Accept as cost of independence. Benefits (standards compliance, independent distribution) outweigh maintenance burden.

## Open Questions

1. **Agent treatment**
   - What we know: Agents spawn from skills via Task tool
   - What's unclear: Should agents have their own `references/` or merge into skills?
   - Recommendation: Create `agents/references/` for shared agent resources

2. **Commands treatment**
   - What we know: Commands in `commands/kata/` are thin wrappers that invoke skills
   - What's unclear: Do commands need any resources?
   - Recommendation: Commands should remain thin; skills own all resources

3. **hooks/ treatment**
   - What we know: Hooks in `hooks/` are JavaScript files
   - What's unclear: Do hooks need resource files?
   - Recommendation: Hooks can remain as-is; they don't use @ references

## Sources

### Primary (HIGH confidence)
- Claude Code Plugin Documentation: https://code.claude.com/docs/en/plugin-marketplaces
- Claude Code Skills Documentation: https://code.claude.com/docs/en/skills
- Codebase analysis: `grep -r "@~/.claude/kata/" skills/`

### Secondary (MEDIUM confidence)
- Agent Skills NPM Boilerplate: https://github.com/neovateai/agent-skill-npm-boilerplate
- OpenSkills Universal Loader: https://github.com/numman-ali/openskills

### Tertiary (LOW confidence)
- Community marketplace patterns from WebSearch

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Based on official Claude Code documentation
- Architecture: HIGH - Direct codebase analysis
- Pitfalls: HIGH - Documented in CHANGELOG and build tests
- Migration strategy: MEDIUM - Derived from patterns, not tested

**Research date:** 2026-01-24
**Valid until:** 2026-02-24 (30 days - architecture patterns are stable)
