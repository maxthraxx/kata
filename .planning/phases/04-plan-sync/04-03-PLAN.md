---
phase: 04-plan-sync
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - tests/skills/planning-phases.test.js
  - tests/skills/executing-phases.test.js
autonomous: true

must_haves:
  truths:
    - "Plan sync patterns have test coverage"
    - "Tests verify skill content includes GitHub update logic"
  artifacts:
    - path: "tests/skills/planning-phases.test.js"
      provides: "Tests for plan checklist GitHub update"
      contains: "Plan Sync"
    - path: "tests/skills/executing-phases.test.js"
      provides: "Tests for wave completion checkbox update"
      contains: "Plan Sync"
  key_links:
    - from: "test files"
      to: "skill content"
      via: "readFileSync pattern verification"
      pattern: "readFileSync.*SKILL.md"
---

<objective>
Add tests for Phase 4 plan sync patterns

Create tests that verify the skill content includes the required GitHub integration patterns. Follow the existing test pattern from adding-milestones.test.js (Phase 3).

Purpose: Ensure plan sync integration points are testable and maintainable
Output: Updated test files with plan sync verification tests
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/skills/adding-milestones.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plan checklist tests to planning-phases.test.js</name>
  <files>tests/skills/planning-phases.test.js</files>
  <action>
Check if tests/skills/planning-phases.test.js exists. If not, create it following the pattern from adding-milestones.test.js.

Add a describe block "Plan Sync - Plan Checklist (Phase 4)":

```javascript
describe('Plan Sync - Plan Checklist (Phase 4)', () => {
  it('contains GitHub issue update step', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-planning-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    // Verify Step 14 or similar exists for GitHub update
    const hasGitHubStep = skillContent.includes('GitHub Issue') ||
                          skillContent.includes('gh issue edit');

    if (!hasGitHubStep) {
      throw new Error('Expected skill to include GitHub issue update step');
    }
  });

  it('contains config guard for github.enabled', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-planning-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    const hasEnabledCheck = skillContent.includes('GITHUB_ENABLED') ||
                            skillContent.includes('github.enabled');
    const hasIssueModeCheck = skillContent.includes('ISSUE_MODE') ||
                              skillContent.includes('issueMode');

    if (!hasEnabledCheck) {
      throw new Error('Expected skill to check github.enabled config');
    }

    if (!hasIssueModeCheck) {
      throw new Error('Expected skill to check issueMode config');
    }
  });

  it('contains plan checklist construction', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-planning-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    // Verify plan iteration and checklist building
    const hasPlanIteration = skillContent.includes('PLAN.md') ||
                              skillContent.includes('for plan_file');
    const hasChecklistFormat = skillContent.includes('- [ ]') ||
                               skillContent.includes('PLAN_CHECKLIST');

    if (!hasPlanIteration) {
      throw new Error('Expected skill to iterate over PLAN.md files');
    }

    if (!hasChecklistFormat) {
      throw new Error('Expected skill to build checklist with checkbox format');
    }
  });

  it('uses --body-file pattern', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-planning-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    const hasBodyFile = skillContent.includes('--body-file');

    if (!hasBodyFile) {
      throw new Error('Expected skill to use --body-file for safe issue body updates');
    }
  });

  it('contains non-blocking error handling', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-planning-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    // Should warn but not stop workflow on GitHub errors
    const hasNonBlocking = skillContent.includes('Warning') ||
                           skillContent.includes('warn') ||
                           skillContent.includes('Skip') ||
                           skillContent.includes('non-blocking');

    if (!hasNonBlocking) {
      throw new Error('Expected skill to handle GitHub errors non-blocking');
    }
  });
});
```

Use the same test setup pattern as adding-milestones.test.js with testDir, beforeEach, afterEach.
  </action>
  <verify>
```bash
grep -q "Plan Sync.*Plan Checklist" tests/skills/planning-phases.test.js && \
grep -q "gh issue edit" tests/skills/planning-phases.test.js
```
Plan sync describe block exists with GitHub update tests.
  </verify>
  <done>
planning-phases.test.js includes Plan Sync test suite with 5 tests covering:
- GitHub issue update step presence
- Config guard for github.enabled and issueMode
- Plan checklist construction logic
- --body-file pattern usage
- Non-blocking error handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add wave completion tests to executing-phases.test.js</name>
  <files>tests/skills/executing-phases.test.js</files>
  <action>
Check if tests/skills/executing-phases.test.js exists. If not, create it following the pattern from adding-milestones.test.js.

Add a describe block "Plan Sync - Wave Completion (Phase 4)":

```javascript
describe('Plan Sync - Wave Completion (Phase 4)', () => {
  it('contains wave completion GitHub update', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    // Verify wave completion includes GitHub update
    const hasWaveUpdate = skillContent.includes('wave') &&
                          skillContent.includes('gh issue');

    if (!hasWaveUpdate) {
      throw new Error('Expected skill to update GitHub issue on wave completion');
    }
  });

  it('updates per wave not per plan (race condition mitigation)', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    // Verify orchestrator-level update pattern
    const hasWaveCompletion = skillContent.includes('wave complete') ||
                              skillContent.includes('COMPLETED_PLANS_IN_WAVE') ||
                              skillContent.includes('wave.*complete');

    // Should NOT mention per-plan updates in executor
    const mentionsAtomicUpdate = skillContent.includes('atomic') ||
                                  skillContent.includes('once per wave') ||
                                  skillContent.includes('per-wave');

    if (!hasWaveCompletion) {
      throw new Error('Expected skill to update issue at wave completion, not per-plan');
    }
  });

  it('contains checkbox toggle pattern', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    // Verify sed pattern for checkbox toggle
    const hasCheckboxToggle = skillContent.includes('\\[ \\]') ||
                              skillContent.includes('- [ ]') ||
                              skillContent.includes('[x]');

    if (!hasCheckboxToggle) {
      throw new Error('Expected skill to include checkbox toggle pattern');
    }
  });

  it('contains config guard', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    const hasEnabledCheck = skillContent.includes('GITHUB_ENABLED') ||
                            skillContent.includes('github.enabled');

    if (!hasEnabledCheck) {
      throw new Error('Expected skill to check github.enabled config');
    }
  });

  it('uses --body-file pattern', () => {
    const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
    const skillContent = readFileSync(skillPath, 'utf8');

    const hasBodyFile = skillContent.includes('--body-file');

    if (!hasBodyFile) {
      throw new Error('Expected skill to use --body-file for safe issue body updates');
    }
  });
});
```

Use the same test setup pattern with testDir, beforeEach, afterEach. Install kata-executing-phases skill in beforeEach.
  </action>
  <verify>
```bash
grep -q "Plan Sync.*Wave Completion" tests/skills/executing-phases.test.js && \
grep -q "race condition" tests/skills/executing-phases.test.js
```
Wave completion describe block exists with race condition mitigation test.
  </verify>
  <done>
executing-phases.test.js includes Plan Sync test suite with 5 tests covering:
- Wave completion GitHub update presence
- Per-wave update pattern (race condition mitigation)
- Checkbox toggle pattern
- Config guard presence
- --body-file pattern usage
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests to verify skill content patterns</name>
  <files></files>
  <action>
Run the new test suites to verify they pass against the updated skill content:

```bash
npm test -- tests/skills/planning-phases.test.js tests/skills/executing-phases.test.js
```

If tests fail, the skill content from 04-01 and 04-02 may need adjustment. Report any failures.

Note: These are content verification tests (checking patterns in skill files), not integration tests that invoke the Claude CLI. They should run quickly and deterministically.
  </action>
  <verify>
Test output shows all tests passing for both test files.
  </verify>
  <done>
All Plan Sync tests pass, verifying skill content includes required patterns.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run full test suite: `npm test`
2. Verify Plan Sync tests exist in both test files
3. Verify tests pass
</verification>

<success_criteria>
- [ ] planning-phases.test.js has "Plan Sync - Plan Checklist" describe block
- [ ] executing-phases.test.js has "Plan Sync - Wave Completion" describe block
- [ ] Tests verify GitHub update step presence
- [ ] Tests verify config guard presence
- [ ] Tests verify --body-file pattern
- [ ] Tests verify race condition mitigation (per-wave updates)
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-plan-sync/04-03-SUMMARY.md`
</output>
