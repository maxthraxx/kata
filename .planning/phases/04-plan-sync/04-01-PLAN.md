---
phase: 04-plan-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-planning-phases/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Phase issue body includes plan checklist after planning completes"
    - "Plans shown as unchecked markdown checkboxes"
    - "Plan checklist replaces placeholder text in issue body"
  artifacts:
    - path: "skills/kata-planning-phases/SKILL.md"
      provides: "GitHub issue update step after plans created"
      contains: "gh issue edit"
  key_links:
    - from: "kata-planning-phases"
      to: "GitHub phase issue"
      via: "gh issue edit with --body-file"
      pattern: "gh issue edit.*--body-file"
---

<objective>
Add GitHub issue update to kata-planning-phases skill

After plans are created, update the corresponding phase issue with a checklist of plan names. This provides visibility into planned work directly in GitHub Issues.

Purpose: Implement Phase 4 success criterion #1 (phase issue body includes checklist of plans)
Output: Updated kata-planning-phases skill with GitHub integration step
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-plan-sync/04-RESEARCH.md
@.planning/phases/03-phase-issues/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GitHub issue update step to kata-planning-phases</name>
  <files>skills/kata-planning-phases/SKILL.md</files>
  <action>
Add a new step between step 13 (Present Final Status) and the `<offer_next>` section. Insert "Step 14: Update GitHub Issue with Plan Checklist (if enabled)".

The step should:

1. **Config Guard Check:**
```bash
GITHUB_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
ISSUE_MODE=$(cat .planning/config.json 2>/dev/null | grep -o '"issueMode"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "never")
```

If `GITHUB_ENABLED != true` OR `ISSUE_MODE = never`: Skip step with log message.

2. **Find Phase Issue:**
```bash
# Get milestone version
VERSION=$(grep -oE 'v[0-9]+\.[0-9]+(\.[0-9]+)?' .planning/ROADMAP.md | head -1 | tr -d 'v' || echo "")

# Find phase issue number
ISSUE_NUMBER=$(gh issue list \
  --label "phase" \
  --milestone "v${VERSION}" \
  --json number,title \
  --jq ".[] | select(.title | startswith(\"Phase ${PHASE}:\")) | .number" \
  2>/dev/null)
```

If issue not found: Warn and skip (non-blocking).

3. **Build Plan Checklist:**
```bash
PLAN_CHECKLIST=""
for plan_file in $(ls "${PHASE_DIR}"/*-PLAN.md 2>/dev/null | sort); do
  PLAN_NUM=$(basename "$plan_file" | sed -E 's/.*-([0-9]+)-PLAN\.md/\1/')
  # Extract brief objective from plan
  PLAN_OBJECTIVE=$(grep -A2 "<objective>" "$plan_file" | head -2 | tail -1 | sed 's/^ *//' | head -c 60)
  PLAN_CHECKLIST="${PLAN_CHECKLIST}- [ ] Plan ${PLAN_NUM}: ${PLAN_OBJECTIVE}
"
done
```

4. **Update Issue Body:**
- Read current body: `gh issue view $ISSUE_NUMBER --json body --jq '.body'`
- Delete placeholder line: `_Plans will be added after phase planning completes._`
- Insert checklist after `## Plans` section using sed/awk
- Write to temp file: `/tmp/phase-issue-body.md`
- Update issue: `gh issue edit $ISSUE_NUMBER --body-file /tmp/phase-issue-body.md`

5. **Success Message:**
`echo "Updated Phase ${PHASE} issue #${ISSUE_NUMBER} with ${PLAN_COUNT} plans"`

Pattern: Use awk for multiline manipulation. Handle case where Plans section may not exist (append if missing).

Make this step non-blocking - failures warn but do not stop planning workflow.
  </action>
  <verify>
```bash
grep -q "Step 14:" skills/kata-planning-phases/SKILL.md && \
grep -q "gh issue edit" skills/kata-planning-phases/SKILL.md && \
grep -q "GITHUB_ENABLED" skills/kata-planning-phases/SKILL.md && \
grep -q "body-file" skills/kata-planning-phases/SKILL.md
```
All four patterns found.
  </verify>
  <done>
kata-planning-phases skill includes Step 14 that:
- Checks github.enabled and issueMode config
- Finds phase issue by milestone and label
- Builds plan checklist from PLAN.md files
- Updates issue body with plan checklist
- Uses non-blocking pattern (warn but continue)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update success criteria and add to offer_next</name>
  <files>skills/kata-planning-phases/SKILL.md</files>
  <action>
Update the success_criteria section to include GitHub issue update:

Add line:
`- [ ] GitHub issue updated with plan checklist (if github.enabled and issueMode != never)`

Update offer_next section to show GitHub status when applicable:

After the wave table, add conditional output:
```
{If GitHub enabled:}
GitHub Issue: #{issue_number} updated with plan checklist
```

This gives users visibility that the GitHub issue was synchronized.
  </action>
  <verify>
```bash
grep -q "GitHub issue updated" skills/kata-planning-phases/SKILL.md && \
grep -q "GitHub Issue:" skills/kata-planning-phases/SKILL.md
```
Both patterns found.
  </verify>
  <done>
- Success criteria includes GitHub issue update condition
- offer_next section shows GitHub issue status when enabled
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Read skills/kata-planning-phases/SKILL.md
2. Verify Step 14 exists with complete GitHub issue update logic
3. Verify config guard checks for both github.enabled and issueMode
4. Verify uses --body-file pattern for special character safety
5. Verify non-blocking error handling (warn but continue)
</verification>

<success_criteria>
- [ ] Step 14 added between step 13 and offer_next
- [ ] Config guard checks github.enabled and issueMode
- [ ] Phase issue lookup by milestone and label
- [ ] Plan checklist built from PLAN.md files in phase directory
- [ ] Issue body updated with checklist (replacing placeholder)
- [ ] Uses --body-file pattern for safe body updates
- [ ] Non-blocking error handling (warn but don't stop workflow)
- [ ] Success criteria updated
- [ ] offer_next shows GitHub status when applicable
</success_criteria>

<output>
After completion, create `.planning/phases/04-plan-sync/04-01-SUMMARY.md`
</output>
