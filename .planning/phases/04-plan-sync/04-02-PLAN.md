---
phase: 04-plan-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-executing-phases/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Plan checkbox checked after wave completes"
    - "Issue updated once per wave (not per plan)"
    - "Completed plans show as [x] in GitHub issue"
  artifacts:
    - path: "skills/kata-executing-phases/SKILL.md"
      provides: "GitHub issue checkbox update after wave completion"
      contains: "gh issue edit"
  key_links:
    - from: "kata-executing-phases orchestrator"
      to: "GitHub phase issue"
      via: "wave completion hook"
      pattern: "wave.*complete.*gh issue"
---

<objective>
Add GitHub issue checkbox update to kata-executing-phases orchestrator

After each wave completes, update the phase issue to check off completed plans. This is done at the orchestrator level (not in individual executors) to avoid race conditions when multiple plans in a wave complete simultaneously.

Purpose: Implement Phase 4 success criteria #2 and #3 (checklist items checked as plans complete)
Output: Updated kata-executing-phases skill with GitHub integration per-wave
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-plan-sync/04-RESEARCH.md
@.planning/phases/03-phase-issues/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wave completion GitHub update to kata-executing-phases</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
Modify step 4 (Execute waves) in the process section. After each wave completes and SUMMARYs are verified, add GitHub issue update logic.

Insert after "Verify SUMMARYs created" and before "Proceed to next wave":

**Step 4.5: Update GitHub Issue Checkboxes (if enabled)**

```markdown
After wave completion, update phase issue checkboxes:

Check github.enabled and issueMode:
```bash
GITHUB_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
ISSUE_MODE=$(cat .planning/config.json 2>/dev/null | grep -o '"issueMode"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "never")
```

**If `GITHUB_ENABLED != true` OR `ISSUE_MODE = never`:** Skip GitHub update.

**Otherwise:**

1. Find phase issue number:
```bash
VERSION=$(grep -oE 'v[0-9]+\.[0-9]+(\.[0-9]+)?' .planning/ROADMAP.md | head -1 | tr -d 'v')
ISSUE_NUMBER=$(gh issue list \
  --label "phase" \
  --milestone "v${VERSION}" \
  --json number,title \
  --jq ".[] | select(.title | startswith(\"Phase ${PHASE}:\")) | .number" \
  2>/dev/null)
```

If issue not found: Warn and skip (non-blocking).

2. Read current issue body:
```bash
ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body' 2>/dev/null)
```

3. For each completed plan in this wave, update checkbox:
```bash
for plan_num in ${COMPLETED_PLANS_IN_WAVE}; do
  # Format: Plan 01, Plan 02, etc.
  PLAN_ID="Plan $(printf "%02d" $plan_num):"
  # Update checkbox: - [ ] -> - [x]
  ISSUE_BODY=$(echo "$ISSUE_BODY" | sed "s/^- \[ \] ${PLAN_ID}/- [x] ${PLAN_ID}/")
done
```

4. Write and update:
```bash
printf '%s\n' "$ISSUE_BODY" > /tmp/phase-issue-body.md
gh issue edit "$ISSUE_NUMBER" --body-file /tmp/phase-issue-body.md 2>/dev/null \
  && echo "Updated issue #${ISSUE_NUMBER}: checked off Wave ${WAVE_NUM} plans" \
  || echo "Warning: Failed to update issue #${ISSUE_NUMBER}"
```

This update happens ONCE per wave (after all plans in wave complete), not per-plan, avoiding race conditions.
```

The key insight from research: Individual executors run in parallel and would race condition if each tried to update the issue. The orchestrator sees when the wave is done and updates atomically.
  </action>
  <verify>
```bash
grep -q "4.5" skills/kata-executing-phases/SKILL.md || grep -q "wave.*complete" skills/kata-executing-phases/SKILL.md && \
grep -q "gh issue edit" skills/kata-executing-phases/SKILL.md && \
grep -q "COMPLETED_PLANS" skills/kata-executing-phases/SKILL.md
```
GitHub issue update logic present in wave completion section.
  </verify>
  <done>
kata-executing-phases orchestrator includes wave completion hook that:
- Checks github.enabled and issueMode config
- Updates issue body only after wave completes (not per-plan)
- Checks off all completed plans from that wave in one atomic update
- Uses non-blocking pattern (warn but continue)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update success criteria and offer_next</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
Update success_criteria section to include:
`- [ ] GitHub issue checkboxes updated per wave (if github.enabled)`

Update offer_next Route A (phase complete) to show GitHub status when applicable:

After "Goal verified âœ“", add conditional output:
```
{If GitHub enabled:}
GitHub Issue: #{issue_number} ({checked}/{total} plans checked off)
```

This provides visibility that GitHub is in sync with local execution state.
  </action>
  <verify>
```bash
grep -q "GitHub issue checkboxes" skills/kata-executing-phases/SKILL.md && \
grep -q "plans checked off" skills/kata-executing-phases/SKILL.md
```
Both patterns found.
  </verify>
  <done>
- Success criteria includes GitHub checkbox update
- Route A shows GitHub issue status with checkbox count
  </done>
</task>

<task type="auto">
  <name>Task 3: Update github-integration.md reference</name>
  <files>skills/kata-executing-phases/references/github-integration.md</files>
  <action>
Update the github-integration.md reference file to mark Phase 4 as Implemented.

In the integration_points section:
1. Update the `### Phase 4: Plan Updates (Planned)` header to remove "(Planned)"
2. Add implementation details showing the wave-level update pattern
3. Update the summary table to show Phase 4 as "Implemented"

Add details under Phase 4 section:
```markdown
### Phase 4: Plan Updates (Implemented)

**Skill:** `kata-planning-phases`
**When:** After PLAN.md files created (Step 14)
**GitHub Action:** Update phase issue with plan checklist

**Flow:**
1. Check `github.enabled` and `issueMode`
2. Find phase issue by milestone and label
3. Build checklist from PLAN.md files
4. Replace placeholder text with checklist
5. Update issue with `--body-file`

**Skill:** `kata-executing-phases`
**When:** After each wave completes (Step 4.5)
**GitHub Action:** Check off completed plans in issue

**Flow:**
1. Check `github.enabled` and `issueMode`
2. Find phase issue by milestone and label
3. Read current issue body
4. Update checkboxes for all plans completed in wave
5. Write updated body atomically

**Race Condition Mitigation:**
Issue updated at orchestrator level per-wave, not in individual executors. This ensures sequential updates when multiple plans complete simultaneously in a wave.
```

Update summary table row for Phase 4 from "Planned" to "Implemented".
  </action>
  <verify>
```bash
grep -q "Phase 4.*Implemented" skills/kata-executing-phases/references/github-integration.md && \
grep -q "Race Condition" skills/kata-executing-phases/references/github-integration.md
```
Both patterns found.
  </verify>
  <done>
github-integration.md updated with Phase 4 implementation details including race condition mitigation strategy.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Read skills/kata-executing-phases/SKILL.md
2. Verify wave completion includes GitHub update step
3. Verify update happens per-wave not per-plan
4. Verify config guards present
5. Verify github-integration.md shows Phase 4 as Implemented
</verification>

<success_criteria>
- [ ] Wave completion step includes GitHub checkbox update
- [ ] Update happens once per wave (race condition mitigation)
- [ ] Config guard checks github.enabled and issueMode
- [ ] Uses --body-file pattern for safe body updates
- [ ] Non-blocking error handling
- [ ] Success criteria updated
- [ ] offer_next shows GitHub status
- [ ] github-integration.md updated to show Phase 4 Implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-plan-sync/04-02-SUMMARY.md`
</output>
