---
phase: 01-release-automation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - skills/completing-milestones/SKILL.md
  - skills/completing-milestones/references/milestone-complete.md
autonomous: false

must_haves:
  truths:
    - "User can auto-generate changelog entries from conventional commits when completing milestone"
    - "User can auto-detect semantic version bump based on commit types"
    - "User can trigger release workflow from milestone completion flow"
    - "User can dry-run release to validate workflow without publishing"
  artifacts:
    - path: "skills/completing-milestones/SKILL.md"
      provides: "Release automation integration"
      contains: "release"
    - path: "skills/completing-milestones/references/milestone-complete.md"
      provides: "Release workflow steps"
      contains: "generate_release"
  key_links:
    - from: "SKILL.md"
      to: "references/version-detector.md"
      via: "@-reference"
      pattern: "@./references/version-detector.md"
    - from: "SKILL.md"
      to: "references/changelog-generator.md"
      via: "@-reference"
      pattern: "@./references/changelog-generator.md"
    - from: "milestone-complete.md"
      to: "gh release create"
      via: "GitHub CLI"
      pattern: "gh release create"
---

<objective>
Integrate release automation into the completing-milestones skill workflow.

Purpose: Enable users to auto-generate changelogs, detect version bumps, and trigger releases as part of milestone completion, with dry-run support for validation.

Output: Updated completing-milestones skill with optional release automation steps and human review gates.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-release-automation/01-RESEARCH.md

# Files to modify
@skills/completing-milestones/SKILL.md
@skills/completing-milestones/references/milestone-complete.md

# Reference files created in Plan 01 (read these for the functions)
@skills/completing-milestones/references/version-detector.md
@skills/completing-milestones/references/changelog-generator.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SKILL.md with release automation</name>
  <files>skills/completing-milestones/SKILL.md</files>
  <action>
Update the completing-milestones SKILL.md to include release automation as optional steps.

Changes to make:

1. **Add @-references in execution_context:**
   ```xml
   - @./references/version-detector.md (version bump detection)
   - @./references/changelog-generator.md (changelog generation)
   ```

2. **Update process section** — After step 0 (Pre-flight: Release artifacts), add new release automation steps:

   **Step 0.5: Release Automation (Optional)**

   Offer release automation before manual artifact checks:

   Use AskUserQuestion:
   - header: "Release Automation"
   - question: "Would you like to auto-generate release artifacts?"
   - options:
     - "Yes, generate changelog and detect version" — Run release automation
     - "Dry run — show what would be generated" — Preview without writing
     - "Skip — I'll prepare artifacts manually" — Continue to existing flow

   **If "Yes" or "Dry run":**
   1. Load version-detector.md and changelog-generator.md references
   2. Detect version bump from commits since last tag
   3. Calculate next version
   4. Generate changelog entry
   5. Present for review:
      ```
      ## Detected Release

      **Version bump:** {major|minor|patch} → v{X.Y.Z}
      **Reason:** {N} feat commits, {M} fix commits, {breaking changes if any}

      **Generated changelog entry:**
      {changelog_entry}

      {If dry run: "DRY RUN — no files modified"}
      ```
   6. If not dry run, ask to apply:
      - "Apply changes" — Write to CHANGELOG.md, update package.json and plugin.json
      - "Edit first" — Pause for user to modify, then apply
      - "Cancel" — Discard and continue with manual flow

3. **Update step 7 (Commit and tag)** — After PR creation/tag, add release step:

   **Step 7.5: Create GitHub Release (Optional)**

   If release artifacts were generated and PR workflow is enabled:

   Use AskUserQuestion:
   - header: "GitHub Release"
   - question: "Create GitHub Release after PR merges?"
   - options:
     - "Yes, include release notes" — Show gh release create command
     - "Skip release" — Just merge PR

   **If "Yes":**
   Display instructions:
   ```
   After PR merges, create release:

   gh release create v{X.Y.Z} \
     --title "v{X.Y.Z}" \
     --notes "$(cat <<'EOF'
   {generated_changelog_entry}
   EOF
   )" \
     --target main

   This triggers CI to publish to marketplace.
   ```

4. **Update success_criteria** — Add:
   - Release artifacts auto-generated (if user chose automation)
   - Dry-run validates workflow without side effects
  </action>
  <verify>
SKILL.md contains:
- @-references to version-detector.md and changelog-generator.md
- Release automation step with AskUserQuestion options
- Dry run option
- GitHub Release instructions
  </verify>
  <done>
SKILL.md offers release automation during milestone completion with dry-run support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update milestone-complete.md with release workflow</name>
  <files>skills/completing-milestones/references/milestone-complete.md</files>
  <action>
Update the milestone-complete.md reference to include detailed release workflow logic.

Add a new section after `<step name="verify_readiness">`:

```xml
<step name="generate_release">

Optional release automation — generates version bump and changelog from commits.

**Load references:**
- @./version-detector.md (version detection functions)
- @./changelog-generator.md (changelog generation functions)

**Process:**

1. **Detect version bump:**
   ```bash
   # Get commits since last tag
   LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

   if [ -n "$LAST_TAG" ]; then
     COMMITS=$(git log --oneline --format="%s" "$LAST_TAG"..HEAD)
   else
     COMMITS=$(git log --oneline --format="%s")
   fi

   # Categorize commits
   BREAKING=$(echo "$COMMITS" | grep -E "^[a-z]+(\(.+\))?!:|BREAKING CHANGE:" || true)
   FEATURES=$(echo "$COMMITS" | grep -E "^feat(\(.+\))?:" || true)
   FIXES=$(echo "$COMMITS" | grep -E "^fix(\(.+\))?:" || true)

   # Determine bump type
   if [ -n "$BREAKING" ]; then
     BUMP_TYPE="major"
   elif [ -n "$FEATURES" ]; then
     BUMP_TYPE="minor"
   elif [ -n "$FIXES" ]; then
     BUMP_TYPE="patch"
   else
     BUMP_TYPE="none"
   fi
   ```

2. **Calculate next version:**
   ```bash
   CURRENT_VERSION=$(cat package.json | grep '"version"' | sed 's/.*"version": "\([^"]*\)".*/\1/')

   IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"

   case "$BUMP_TYPE" in
     major) NEXT_VERSION="$((major + 1)).0.0" ;;
     minor) NEXT_VERSION="${major}.$((minor + 1)).0" ;;
     patch) NEXT_VERSION="${major}.${minor}.$((patch + 1))" ;;
     *) NEXT_VERSION="$CURRENT_VERSION" ;;
   esac
   ```

3. **Generate changelog entry:**
   ```bash
   DATE=$(date +%Y-%m-%d)

   CHANGELOG_ENTRY="## [$NEXT_VERSION] - $DATE"

   if [ -n "$FEATURES" ]; then
     CHANGELOG_ENTRY="$CHANGELOG_ENTRY

### Added"
     while IFS= read -r line; do
       desc=$(echo "$line" | sed 's/^feat\([^:]*\): //')
       CHANGELOG_ENTRY="$CHANGELOG_ENTRY
- $desc"
     done <<< "$FEATURES"
   fi

   # Similar for fixes, changes, breaking...
   ```

4. **Dry run output:**
   ```
   ═══════════════════════════════════════════════════════════════
   DRY RUN: Release Preview
   ═══════════════════════════════════════════════════════════════

   Version: {CURRENT_VERSION} → {NEXT_VERSION} ({BUMP_TYPE})

   Commits analyzed: {N} total
   - Breaking: {X}
   - Features: {Y}
   - Fixes: {Z}
   - Other: {W}

   Generated changelog:
   ───────────────────────────────────────────────────────────────
   {CHANGELOG_ENTRY}
   ───────────────────────────────────────────────────────────────

   Files that would be modified:
   - CHANGELOG.md (prepend entry)
   - package.json (version → {NEXT_VERSION})
   - .claude-plugin/plugin.json (version → {NEXT_VERSION})

   ═══════════════════════════════════════════════════════════════
   No files were modified (dry run)
   ═══════════════════════════════════════════════════════════════
   ```

5. **Apply changes (if not dry run):**
   ```bash
   # Update package.json
   jq --arg v "$NEXT_VERSION" '.version = $v' package.json > package.json.tmp
   mv package.json.tmp package.json

   # Update plugin.json
   jq --arg v "$NEXT_VERSION" '.version = $v' .claude-plugin/plugin.json > plugin.json.tmp
   mv plugin.json.tmp .claude-plugin/plugin.json

   # Prepend to CHANGELOG.md
   # (Insert after first line which is typically "# Changelog")
   ```

6. **Human review gate:**
   Always present generated changelog for review before writing.
   User can edit, approve, or cancel.

</step>
```

Also add release instructions to the `<step name="git_tag">` section for GitHub Release creation.
  </action>
  <verify>
milestone-complete.md contains:
- generate_release step with bash functions
- Dry run output format
- Human review gate
- Version file update commands (package.json, plugin.json)
  </verify>
  <done>
milestone-complete.md provides detailed release workflow that integrates with existing milestone completion.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Release automation integrated into completing-milestones skill:
- Version detection from conventional commits
- Changelog generation in Keep a Changelog format
- Dry-run mode for validation
- Human review gates before writing files
  </what-built>
  <how-to-verify>
1. Open a test project with some conventional commits
2. Run `/kata:complete-milestone v9.9.9` (use fake version)
3. Select "Dry run — show what would be generated"
4. Verify:
   - Version bump is correctly detected (major/minor/patch)
   - Changelog entry is properly formatted
   - Dry run shows preview without modifying files
5. Cancel the milestone completion (don't actually complete)

Expected behavior:
- Dry run shows version bump calculation
- Dry run shows generated changelog entry
- No files are modified during dry run
- User can see exactly what would be generated
  </how-to-verify>
  <resume-signal>Type "approved" if release automation works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. SKILL.md references version-detector.md and changelog-generator.md
2. SKILL.md includes release automation step with dry-run option
3. milestone-complete.md includes generate_release step
4. Human verification confirms dry-run works correctly
</verification>

<success_criteria>
- REL-01 complete: User can auto-generate changelog entries from conventional commits
- REL-02 complete: User can auto-detect semantic version bump based on commit types
- REL-03 complete: User can trigger release workflow from milestone completion
- REL-04 complete: User can dry-run release to validate workflow without publishing
- Version bump updates both package.json and .claude-plugin/plugin.json
- Changelog generation preserves manual curation quality (review gate before publish)
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-automation/01-02-SUMMARY.md`
</output>
