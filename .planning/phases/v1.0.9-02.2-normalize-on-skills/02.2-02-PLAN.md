---
phase: 02.2-normalize-on-skills
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build.js
autonomous: true

must_haves:
  truths:
    - "Plugin build outputs skills without kata- prefix in directory names"
    - "Plugin build outputs skills with name field stripped of kata- prefix"
    - "NPX build unchanged (keeps kata- prefix)"
    - "Skills invocable as /kata:planning-phases in plugin context"
  artifacts:
    - path: "scripts/build.js"
      provides: "Skill directory and name transformation for plugin"
      contains: "kata-"
  key_links:
    - from: "scripts/build.js"
      to: "dist/plugin/skills/"
      via: "buildPlugin() function"
      pattern: "transformPluginPaths"
---

<objective>
Update build.js to strip `kata-` prefix from skill directories and `name` field for plugin distribution.

Purpose: Plugin namespace adds `kata:` prefix to skills automatically. With `kata-` in skill names, users would invoke `/kata:kata-planning-phases` (redundant). Stripping the prefix yields clean `/kata:planning-phases`.

Output: build.js updated to transform skill directories and names during plugin build.
</objective>

<context>
@.planning/ROADMAP.md
@scripts/build.js

**Current plugin behavior:**
- Skills copied as-is: `skills/kata-planning-phases/` -> `dist/plugin/skills/kata-planning-phases/`
- Name in SKILL.md frontmatter: `name: kata-planning-phases`
- Plugin invocation: `/kata:kata-planning-phases` (double kata)

**Target plugin behavior:**
- Skills transformed: `skills/kata-planning-phases/` -> `dist/plugin/skills/planning-phases/`
- Name transformed: `name: kata-planning-phases` -> `name: planning-phases`
- Plugin invocation: `/kata:planning-phases` (clean)

**NPX behavior (unchanged):**
- Skills copied as-is
- Invocation: `/kata-planning-phases`

**Key build.js structure:**
- `COMMON_INCLUDES` lists directories to copy (includes 'skills')
- `copyDir()` recursively copies with optional transform
- `transformPluginPaths()` already handles agent reference transforms
- `buildPlugin()` calls `copyPath(item, dest, transformPluginPaths, shouldExcludeFromPlugin)`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skill name transformation function to build.js</name>
  <files>scripts/build.js</files>
  <action>
Add a new function to transform the `name:` field in SKILL.md frontmatter by stripping the `kata-` prefix.

Add after `transformPluginPaths()`:

```javascript
/**
 * Transform skill names for plugin distribution
 *
 * Plugin skills are namespaced as pluginname:skillname.
 * Source skills are named kata-* (e.g., kata-planning-phases).
 * Without transformation: /kata:kata-planning-phases (redundant)
 * With transformation: /kata:planning-phases (clean)
 *
 * This function:
 * 1. Strips kata- prefix from name field in SKILL.md frontmatter
 * 2. Applied during plugin build only (NPX keeps original names)
 */
function transformSkillName(content) {
  // Transform name: kata-* to name: * in frontmatter
  // Only match at start of line to avoid false positives in content
  return content.replace(/^(name:\s*)kata-/m, '$1');
}

/**
 * Combined transform for plugin .md files
 * Applies both agent reference and skill name transforms
 */
function transformPluginContent(content) {
  let result = transformPluginPaths(content);  // Existing: subagent_type transform
  result = transformSkillName(result);          // New: name field transform
  return result;
}
```

Update `buildPlugin()` to use the combined transform:

Change this line in `buildPlugin()`:
```javascript
if (copyPath(item, dest, transformPluginPaths, shouldExcludeFromPlugin)) {
```

To:
```javascript
if (copyPath(item, dest, transformPluginContent, shouldExcludeFromPlugin)) {
```
  </action>
  <verify>
```bash
# Verify the functions exist
grep -n "transformSkillName" scripts/build.js
grep -n "transformPluginContent" scripts/build.js
```
  </verify>
  <done>Skill name transformation function added to build.js</done>
</task>

<task type="auto">
  <name>Task 2: Add skill directory renaming for plugin build</name>
  <files>scripts/build.js</files>
  <action>
Update the skill copying logic to rename `kata-*` directories to just `*` for plugin build.

Modify `copyDir()` or add new logic in `buildPlugin()` to handle skill directory renaming.

**Option: Add directory rename logic in copyDir**

Add a `renameDir` parameter to `copyDir()` function:

```javascript
/**
 * Recursively copy a directory with optional path transformation
 * @param {string} src - Source directory
 * @param {string} dest - Destination directory
 * @param {Function} transform - Content transform function
 * @param {Function} excludeFilter - Path exclusion filter
 * @param {Function} renameDir - Directory rename function (optional)
 */
function copyDir(src, dest, transform = null, excludeFilter = null, renameDir = null) {
  if (!fs.existsSync(src)) {
    console.log(`  ${amber}!${reset} Skipping ${src} (not found)`);
    return false;
  }

  fs.mkdirSync(dest, { recursive: true });
  const entries = fs.readdirSync(src, { withFileTypes: true });

  for (const entry of entries) {
    // Skip excluded files/directories
    if (shouldExclude(entry.name)) continue;
    // Skip hooks/dist - it's for npm publishing only
    if (entry.name === 'dist' && src.includes('hooks')) continue;

    const srcPath = path.join(src, entry.name);

    // Apply directory rename if provided
    const destName = entry.isDirectory() && renameDir ? renameDir(entry.name) : entry.name;
    const destPath = path.join(dest, destName);

    // Check plugin-specific exclusions using relative path from ROOT
    if (excludeFilter) {
      const relativePath = path.relative(ROOT, srcPath);
      if (excludeFilter(relativePath)) {
        console.log(`  ${dim}-${reset} Excluded ${relativePath} (plugin-specific)`);
        continue;
      }
    }

    if (entry.isDirectory()) {
      copyDir(srcPath, destPath, transform, excludeFilter, renameDir);
    } else {
      copyFile(srcPath, destPath, transform);
    }
  }
  return true;
}
```

Then update `copyPath()` to accept and pass through the `renameDir` parameter:

```javascript
function copyPath(src, dest, transform = null, excludeFilter = null, renameDir = null) {
  // ... existing code ...
  if (stat.isDirectory()) {
    return copyDir(srcPath, destPath, transform, excludeFilter, renameDir);
  }
  // ... rest unchanged
}
```

Add the directory rename function for plugin build:

```javascript
/**
 * Rename skill directories for plugin distribution
 * Strips kata- prefix: kata-planning-phases -> planning-phases
 */
function renameSkillDir(name) {
  if (name.startsWith('kata-')) {
    return name.slice(5);  // Remove 'kata-' (5 chars)
  }
  return name;
}
```

Update `buildPlugin()` to pass the rename function for skills:

```javascript
// Copy common files with path transformation AND plugin exclusions
for (const item of COMMON_INCLUDES) {
  // Use directory rename only for skills directory
  const dirRename = item === 'skills' ? renameSkillDir : null;
  if (copyPath(item, dest, transformPluginContent, shouldExcludeFromPlugin, dirRename)) {
    console.log(`  ${green}âœ“${reset} Copied ${item}`);
  }
}
```
  </action>
  <verify>
```bash
# Run plugin build
node scripts/build.js plugin

# Verify skills directories renamed (no kata- prefix)
ls dist/plugin/skills/ | head -5
# Should show: adding-phases, adding-todos, etc. (no kata- prefix)

# Verify name field transformed in a skill
grep "^name:" dist/plugin/skills/planning-phases/SKILL.md
# Should show: name: planning-phases
```
  </verify>
  <done>Plugin build strips kata- prefix from skill directories and names</done>
</task>

<task type="auto">
  <name>Task 3: Verify NPX build unchanged</name>
  <files>scripts/build.js</files>
  <action>
Run NPX build and verify skills keep their original names.

```bash
node scripts/build.js npm

# Verify skills directories unchanged
ls dist/npm/skills/ | head -5
# Should show: kata-adding-phases, kata-adding-todos, etc.

# Verify name field unchanged
grep "^name:" dist/npm/skills/kata-planning-phases/SKILL.md
# Should show: name: kata-planning-phases
```
  </action>
  <verify>
```bash
# Verify NPX keeps kata- prefix
ls dist/npm/skills/ | grep "^kata-" | wc -l
# Should be 26+ (all skills have kata- prefix)

# Verify plugin strips kata- prefix
ls dist/plugin/skills/ | grep -v "^kata-" | wc -l
# Should be 26+ (no kata- prefix)
```
  </verify>
  <done>NPX build unchanged, plugin build correctly transforms</done>
</task>

<task type="auto">
  <name>Task 4: Commit build.js changes</name>
  <files>scripts/build.js</files>
  <action>
Stage and commit the build.js changes:

```bash
git add scripts/build.js
git commit -m "feat(02.2-02): strip kata- prefix from skills in plugin build

- Add transformSkillName() to strip prefix from name field
- Add renameSkillDir() to strip prefix from directory names
- Plugin: /kata:planning-phases (clean namespace)
- NPX: /kata-planning-phases (unchanged)

Co-Authored-By: Claude <noreply@anthropic.com>"
```
  </action>
  <verify>
```bash
git log -1 --oneline
```
  </verify>
  <done>Build.js changes committed</done>
</task>

</tasks>

<verification>
After completion:
- [ ] `node scripts/build.js plugin` succeeds
- [ ] `ls dist/plugin/skills/` shows directories without kata- prefix
- [ ] `grep "^name:" dist/plugin/skills/planning-phases/SKILL.md` shows `name: planning-phases`
- [ ] `node scripts/build.js npm` succeeds
- [ ] `ls dist/npm/skills/` shows directories with kata- prefix
- [ ] Git commit created
</verification>

<success_criteria>
- Plugin build transforms skill directories: kata-* -> *
- Plugin build transforms skill names: kata-* -> *
- NPX build unchanged (keeps kata- prefix everywhere)
- Build validation passes for both targets
</success_criteria>

<output>
After completion, create `.planning/phases/v1.0.9-02.2-normalize-on-skills/02.2-02-SUMMARY.md`
</output>
