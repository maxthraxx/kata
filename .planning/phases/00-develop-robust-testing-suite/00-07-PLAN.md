---
phase: 00-develop-robust-testing-suite
plan: 07
type: execute
wave: 3
depends_on: ["00-02", "00-03", "00-04", "00-05", "00-06"]
files_modified:
  - .github/workflows/test-skills.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "CI workflow runs on every PR"
    - "Only affected skill tests run (cost control)"
    - "Test failures appear as PR annotations"
    - "Full test suite runs on main branch"
  artifacts:
    - path: ".github/workflows/test-skills.yml"
      provides: "GitHub Actions workflow for skill tests"
      contains: "test-skills"
    - path: "package.json"
      provides: "Updated npm scripts for test execution"
      contains: "test:skills"
  key_links:
    - from: ".github/workflows/test-skills.yml"
      to: "tests/harness/affected.js"
      via: "node import"
      pattern: "getAffectedTestFiles"
---

<objective>
Create GitHub Actions CI workflow for skill tests with affected-test detection.

Purpose: Integrate skill testing into CI/CD pipeline. Only run tests for changed skills to control API costs, while still catching regressions. Report failures as PR annotations.

Output: GitHub Actions workflow and npm scripts for automated skill testing.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/00-develop-robust-testing-suite/00-CONTEXT.md
@.planning/phases/00-develop-robust-testing-suite/00-RESEARCH.md

Existing workflows:
@.github/workflows/publish.yml
@.github/workflows/plugin-release.yml

Test harness:
@tests/harness/affected.js
@tests/README.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .github/workflows/test-skills.yml</name>
  <files>.github/workflows/test-skills.yml</files>
  <action>
Create `.github/workflows/test-skills.yml`:

```yaml
name: Skill Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      affected_tests: ${{ steps.affected.outputs.test_files }}
      has_affected: ${{ steps.affected.outputs.has_tests }}
      run_full: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect affected skills
        id: affected
        run: |
          AFFECTED=$(node -e "
            import('./tests/harness/affected.js').then(m => {
              const files = m.getAffectedTestFiles();
              console.log(files.join(' '));
            }).catch(() => console.log(''));
          ")
          echo "test_files=$AFFECTED" >> $GITHUB_OUTPUT
          echo "has_tests=$( [ -n \"$AFFECTED\" ] && echo true || echo false )" >> $GITHUB_OUTPUT

  test-affected:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_affected == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run affected skill tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node --test \
            --test-reporter spec \
            --test-reporter junit --test-reporter-destination junit.xml \
            ${{ needs.detect-changes.outputs.affected_tests }}

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'junit.xml'
          fail_on_failure: true
          include_passed: false
          check_name: 'Affected Skill Tests'

  test-full:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_full == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run all skill tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npm run test:skills

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'junit.xml'
          fail_on_failure: true
          include_passed: false
          check_name: 'Full Skill Tests'
```

Key features:
- Runs on PRs and pushes to main
- PRs run only affected tests (cost control)
- Main branch runs full test suite
- Uses mikepenz/action-junit-report for PR annotations
- Requires ANTHROPIC_API_KEY secret
  </action>
  <verify>Validate YAML syntax: `cat .github/workflows/test-skills.yml | python3 -c "import yaml,sys; yaml.safe_load(sys.stdin)"`</verify>
  <done>test-skills.yml workflow created with affected-test detection and PR annotations</done>
</task>

<task type="auto">
  <name>Task 2: Update package.json with skill test scripts</name>
  <files>package.json</files>
  <action>
Update package.json scripts section to add:

```json
"scripts": {
  ...existing scripts...
  "test:skills": "node --test --test-reporter spec --test-reporter junit --test-reporter-destination junit.xml tests/skills/*.test.js",
  "test:skills:affected": "node -e \"import('./tests/harness/affected.js').then(m => console.log(m.getAffectedTestFiles().join(' ')))\" | xargs -r node --test"
}
```

Preserve all existing scripts. The test:skills script:
- Uses node:test runner
- Outputs to both spec (console) and junit (file) formats
- Runs all skill test files

The test:skills:affected script:
- Gets affected test files from affected.js
- Runs only those tests
- Useful for local development
  </action>
  <verify>Run `npm run test:skills -- --help` to verify script is recognized.</verify>
  <done>package.json has test:skills and test:skills:affected npm scripts</done>
</task>

<task type="auto">
  <name>Task 3: Update tests/README.md with CI documentation</name>
  <files>tests/README.md</files>
  <action>
Update tests/README.md to add CI-specific documentation:

1. Add "CI/CD Integration" section:
   - Explain the test-skills.yml workflow
   - Document that PRs run affected tests only
   - Document that main branch runs full suite
   - Explain ANTHROPIC_API_KEY secret requirement

2. Add "Cost Control" section:
   - Explain why affected-test detection matters
   - Show how to run affected tests locally: `npm run test:skills:affected`
   - Document budget tiers from runner.js

3. Add "Troubleshooting CI" section:
   - Common issues (missing API key, test timeouts)
   - How to check workflow logs
   - How to manually trigger tests

Keep existing content, integrate new sections logically.
  </action>
  <verify>Read tests/README.md and verify CI documentation sections exist.</verify>
  <done>tests/README.md documents CI workflow, cost control, and troubleshooting</done>
</task>

</tasks>

<verification>
- `.github/workflows/test-skills.yml` exists and has valid YAML syntax
- `npm run test:skills -- --help` works
- tests/README.md has CI/CD Integration section
- Workflow references `tests/harness/affected.js` for affected-test detection
</verification>

<success_criteria>
- GitHub Actions workflow created for skill tests
- PRs run only affected tests (cost control)
- Main branch runs full test suite
- Test failures appear as PR annotations
- npm scripts added for local and CI test execution
- README documents CI integration
</success_criteria>

<output>
After completion, create `.planning/phases/00-develop-robust-testing-suite/00-07-SUMMARY.md`
</output>
