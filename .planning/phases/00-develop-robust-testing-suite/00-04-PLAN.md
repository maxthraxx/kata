---
phase: 00-develop-robust-testing-suite
plan: 04
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - tests/skills/adding-phases.test.js
  - tests/skills/inserting-phases.test.js
  - tests/skills/removing-phases.test.js
  - tests/skills/discussing-phases.test.js
  - tests/skills/starting-milestones.test.js
  - tests/skills/completing-milestones.test.js
  - tests/skills/auditing-milestones.test.js
autonomous: true

must_haves:
  truths:
    - "adding-phases skill creates phase in ROADMAP.md"
    - "inserting-phases skill adds decimal phases"
    - "removing-phases skill removes phase from ROADMAP.md"
    - "discussing-phases skill facilitates phase discussion"
    - "starting-milestones skill creates milestone structure"
    - "completing-milestones skill archives milestone"
    - "auditing-milestones skill reports milestone status"
  artifacts:
    - path: "tests/skills/adding-phases.test.js"
      provides: "Test for kata-adding-phases skill"
      min_lines: 40
    - path: "tests/skills/inserting-phases.test.js"
      provides: "Test for kata-inserting-phases skill"
      min_lines: 40
    - path: "tests/skills/removing-phases.test.js"
      provides: "Test for kata-removing-phases skill"
      min_lines: 40
    - path: "tests/skills/discussing-phases.test.js"
      provides: "Test for kata-discussing-phases skill"
      min_lines: 30
    - path: "tests/skills/starting-milestones.test.js"
      provides: "Test for kata-starting-milestones skill"
      min_lines: 40
    - path: "tests/skills/completing-milestones.test.js"
      provides: "Test for kata-completing-milestones skill"
      min_lines: 40
    - path: "tests/skills/auditing-milestones.test.js"
      provides: "Test for kata-auditing-milestones skill"
      min_lines: 30
  key_links:
    - from: "tests/skills/adding-phases.test.js"
      to: ".planning/ROADMAP.md"
      via: "readFileSync"
      pattern: "ROADMAP\\.md"
---

<objective>
Create skill tests for phase and milestone management skills (Wave 3 of skill testing).

Purpose: Test skills that manage the roadmap structure - phases and milestones. These are critical for Kata's planning workflow and must create/modify the correct artifacts.

Output: 7 skill test files covering phase and milestone lifecycle management.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/00-develop-robust-testing-suite/00-CONTEXT.md
@.planning/phases/00-develop-robust-testing-suite/00-RESEARCH.md

Test harness:
@tests/harness/claude-cli.js
@tests/harness/assertions.js

Skills to test:
@skills/kata-adding-phases/SKILL.md
@skills/kata-inserting-phases/SKILL.md
@skills/kata-removing-phases/SKILL.md
@skills/kata-discussing-phases/SKILL.md
@skills/kata-starting-milestones/SKILL.md
@skills/kata-completing-milestones/SKILL.md
@skills/kata-auditing-milestones/SKILL.md

Test fixture:
@tests/fixtures/kata-project/.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create adding-phases.test.js, inserting-phases.test.js, and removing-phases.test.js</name>
  <files>tests/skills/adding-phases.test.js, tests/skills/inserting-phases.test.js, tests/skills/removing-phases.test.js</files>
  <action>
Create `tests/skills/adding-phases.test.js`:
1. Standard setup/teardown with kata-adding-phases skill
2. Test cases:
   - "responds to 'add phase for authentication'" - assert skill invoked
   - "modifies ROADMAP.md" - read ROADMAP.md after invocation, assert it contains new phase or "authentication"
   - "creates phase directory" - use assertFileMatchesPattern for .planning/phases/ directory

Create `tests/skills/inserting-phases.test.js`:
1. Standard setup/teardown with kata-inserting-phases skill
2. In beforeEach, add a Phase 1 entry to ROADMAP.md so insertion has context
3. Test cases:
   - "responds to 'insert urgent phase before phase 1'" - assert skill invoked
   - "creates decimal phase" - assert ROADMAP.md contains "0.1" or decimal phase numbering

Create `tests/skills/removing-phases.test.js`:
1. Standard setup/teardown with kata-removing-phases skill
2. In beforeEach, add a Phase 1 entry to ROADMAP.md
3. Test cases:
   - "responds to 'remove phase 1'" - assert skill invoked
   - "updates ROADMAP.md" - verify phase removed or marked

Use config.budgets.standard ($2.00) - these modify roadmap structure.
  </action>
  <verify>
```bash
node --test tests/skills/adding-phases.test.js tests/skills/inserting-phases.test.js tests/skills/removing-phases.test.js
```
  </verify>
  <done>Phase management tests verify ROADMAP.md modifications and phase directory creation</done>
</task>

<task type="auto">
  <name>Task 2: Create discussing-phases.test.js</name>
  <files>tests/skills/discussing-phases.test.js</files>
  <action>
Create `tests/skills/discussing-phases.test.js`:
1. Standard setup/teardown with kata-discussing-phases skill
2. In beforeEach:
   - Add Phase 1 to ROADMAP.md with a goal
   - Create .planning/phases/01-test-phase/ directory
3. Test cases:
   - "responds to 'discuss phase 1'" - assert skill invoked
   - "creates CONTEXT.md" - assert .planning/phases/01-test-phase/01-CONTEXT.md exists after discussion (or assert skill output mentions context/decisions)

Use config.budgets.standard ($2.00) - discussion skills involve back-and-forth.
  </action>
  <verify>
```bash
node --test tests/skills/discussing-phases.test.js
```
  </verify>
  <done>discussing-phases.test.js verifies phase discussion and context creation</done>
</task>

<task type="auto">
  <name>Task 3: Create starting-milestones.test.js, completing-milestones.test.js, and auditing-milestones.test.js</name>
  <files>tests/skills/starting-milestones.test.js, tests/skills/completing-milestones.test.js, tests/skills/auditing-milestones.test.js</files>
  <action>
Create `tests/skills/starting-milestones.test.js`:
1. Standard setup/teardown with kata-starting-milestones skill
2. Test cases:
   - "responds to 'start milestone v2.0'" - assert skill invoked
   - "creates milestone structure" - assert ROADMAP.md mentions v2.0 or milestone created

Create `tests/skills/completing-milestones.test.js`:
1. Standard setup/teardown with kata-completing-milestones skill
2. In beforeEach, set up a milestone in ROADMAP.md that can be completed
3. Test cases:
   - "responds to 'complete milestone'" - assert skill invoked
   - "archives milestone" - assert .planning/milestones/ directory created or ROADMAP.md updated

Create `tests/skills/auditing-milestones.test.js`:
1. Standard setup/teardown with kata-auditing-milestones skill
2. Test cases:
   - "responds to 'audit milestone'" - assert skill invoked
   - "reports milestone status" - assert result mentions milestone, phases, or progress

Use config.budgets.standard ($2.00).
  </action>
  <verify>
```bash
node --test tests/skills/starting-milestones.test.js tests/skills/completing-milestones.test.js tests/skills/auditing-milestones.test.js
```
  </verify>
  <done>Milestone tests verify creation, completion, and audit workflows</done>
</task>

</tasks>

<verification>
```bash
# Run all Wave 3 phase/milestone skill tests
node --test tests/skills/adding-phases.test.js tests/skills/inserting-phases.test.js tests/skills/removing-phases.test.js tests/skills/discussing-phases.test.js tests/skills/starting-milestones.test.js tests/skills/completing-milestones.test.js tests/skills/auditing-milestones.test.js
```
All tests pass (requires ANTHROPIC_API_KEY).
</verification>

<success_criteria>
- 7 test files created for phase and milestone skills
- Phase tests verify ROADMAP.md modifications
- Milestone tests verify lifecycle (start, complete, audit)
- Tests create necessary fixture state for each scenario
- All follow established test patterns
</success_criteria>

<output>
After completion, create `.planning/phases/00-develop-robust-testing-suite/00-04-SUMMARY.md`
</output>
