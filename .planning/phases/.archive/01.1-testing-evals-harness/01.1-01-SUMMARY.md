---
phase: 01.1
plan: 01
subsystem: testing
tags: [test-harness, cli, node-test, esm]

dependency-graph:
  requires: [01.1-RESEARCH]
  provides: [test-harness-utilities, test-fixtures, esm-package]
  affects: [01.1-02, 01.1-03]

tech-stack:
  added: []
  patterns: [subprocess-invocation, json-output-parsing, test-isolation]

key-files:
  created:
    - tests/harness/claude-cli.js
    - tests/harness/assertions.js
    - tests/fixtures/kata-project/.planning/STATE.md
    - tests/fixtures/kata-project/.planning/ROADMAP.md
    - tests/fixtures/kata-project/.planning/todos/pending/.gitkeep
    - tests/fixtures/kata-project/.claude/skills/.gitkeep
    - tests/fixtures/kata-project/CLAUDE.md
  modified:
    - package.json
    - dev/kata-lint.cjs

decisions:
  - "ESM module type added to package.json for test harness compatibility"

metrics:
  duration: 2 min
  completed: 2026-01-20
---

# Phase 1.1 Plan 01: Test Harness Foundation Summary

**One-liner:** Claude CLI wrapper with JSON output parsing, custom skill assertions, and minimal Kata project fixture for isolated testing

## What Was Built

### Task 1: Claude CLI Wrapper Utility
Created `tests/harness/claude-cli.js` with `invokeClaude()` function:
- Wraps `claude -p` with JSON output mode (`--output-format json`)
- Enforces cost limits via `--max-budget-usd` flag (default $1.00)
- Uses `--allowedTools` to prevent permission prompts
- Uses `--no-session-persistence` for test isolation
- Requires `cwd` parameter to prevent accidental real project modification

### Task 2: Custom Assertions
Created `tests/harness/assertions.js` with skill-specific assertions:
- `assertSkillInvoked(result)` - verifies `num_turns > 1` indicating skill execution
- `assertNoError(result)` - checks `is_error` is false
- `assertArtifactExists(basePath, relativePath)` - verifies file/directory creation
- `assertFileMatchesPattern(dirPath, pattern)` - matches filenames with regex
- `assertResultContains(result, expected)` - checks response text content

### Task 3: Minimal Kata Project Fixture
Created `tests/fixtures/kata-project/` with:
- `.planning/STATE.md` - fixture project state
- `.planning/ROADMAP.md` - empty roadmap
- `.planning/todos/pending/.gitkeep` - for todo skill tests
- `.claude/skills/.gitkeep` - for skill installation during tests
- `CLAUDE.md` - test project description

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 684c49e | Create Claude CLI wrapper utility |
| 2 | 6631207 | Create custom assertions for skill verification |
| 3 | 03ca2aa | Create minimal Kata project fixture |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] ESM/CommonJS incompatibility**
- **Found during:** Task 1 verification
- **Issue:** Adding `"type": "module"` to package.json broke kata-lint.js which uses CommonJS `require()` syntax
- **Fix:** Renamed `dev/kata-lint.js` to `dev/kata-lint.cjs` and updated pre-commit hook reference
- **Files modified:** dev/kata-lint.cjs (renamed), .git/hooks/pre-commit
- **Commit:** 03ca2aa (bundled with Task 3)

**2. [Rule 3 - Blocking] .gitignore excluding test fixture**
- **Found during:** Task 3 commit
- **Issue:** `.claude/` pattern in .gitignore excluded test fixture's `.claude/skills/.gitkeep`
- **Fix:** Used `git add -f` to force-add the fixture file
- **Commit:** 03ca2aa

## Verification Results

All checks passed:
- [x] tests/harness/claude-cli.js exists and exports invokeClaude
- [x] tests/harness/assertions.js exists and exports assertion functions
- [x] tests/fixtures/kata-project/.planning/STATE.md exists
- [x] tests/fixtures/kata-project/.planning/ROADMAP.md exists
- [x] tests/fixtures/kata-project/.planning/todos/pending/ directory exists
- [x] tests/fixtures/kata-project/.claude/skills/ directory exists
- [x] All files use ESM syntax (import/export)

## Next Phase Readiness

Ready for Plan 02 (Test Runner Configuration):
- Test utilities available for import
- ESM support enabled in package.json
- Fixture provides isolated test environment

No blockers identified.
