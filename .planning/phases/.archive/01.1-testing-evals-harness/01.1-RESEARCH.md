# Phase 1.1: Testing & Evals Harness - Research

**Researched:** 2026-01-20
**Domain:** CLI-based AI testing, Claude Code programmatic invocation
**Confidence:** HIGH

## Summary

This research investigates how to build a testing framework for Kata skills using Claude Code's CLI capabilities. The Claude CLI provides robust programmatic features via the `-p` (print) flag with JSON output, session management, and tool permission controls that enable automated testing without interactive prompts.

The recommended approach is a Node.js-based test harness using the native `node:test` runner (zero dependencies) that invokes `claude -p` as subprocesses, parses JSON output to verify behavior, and uses temporary directories for test isolation. This aligns with Kata's existing Node.js stack (package.json, bin/install.js).

**Primary recommendation:** Use Node.js native test runner (`node:test`) with subprocess-based Claude CLI invocation, JSON output parsing via jq or native JSON.parse, and mktemp-based test isolation.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| node:test | Node.js 20+ built-in | Test runner | Zero dependencies, native ESM/CJS support, stable since v20 |
| node:assert | Node.js built-in | Assertions | Pairs with node:test, strict mode prevents common errors |
| child_process | Node.js built-in | CLI invocation | Native way to spawn `claude -p` subprocess |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| jq | 1.7+ (system) | JSON parsing | Quick JSON assertions in bash scripts |
| mktemp | system | Test isolation | Create temp directories per test |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| node:test | Jest | Jest adds dependencies but has richer mocking; node:test is sufficient for subprocess testing |
| Node.js | Bash scripts | Bash simpler for simple tests but harder for complex assertions and parallelization |
| jq | Node JSON.parse | jq better for bash, JSON.parse better in Node.js |

**Installation:**
```bash
# No npm install needed - using built-in Node.js modules
# System requirements: Node.js 20+, jq (optional for bash scripts)
```

## Architecture Patterns

### Recommended Project Structure
```
tests/
├── harness/
│   ├── runner.js        # Test runner configuration
│   ├── fixtures/        # Test project templates
│   │   └── kata-project/  # Minimal Kata project structure
│   └── utils/
│       ├── claude-cli.js   # Claude CLI wrapper
│       ├── assertions.js   # Custom assertions
│       └── cleanup.js      # Temp directory cleanup
├── skills/
│   ├── kata-managing-todos.test.js
│   └── ...
└── integration/
    └── skill-invocation.test.js
```

### Pattern 1: Subprocess Invocation with JSON Output
**What:** Invoke Claude CLI as subprocess, capture JSON output for assertions
**When to use:** All skill tests
**Example:**
```javascript
// Source: https://code.claude.com/docs/en/headless
import { execSync } from 'node:child_process';
import { test } from 'node:test';
import assert from 'node:assert';

function invokeClaude(prompt, options = {}) {
  const args = [
    '-p', prompt,
    '--output-format', 'json',
    '--allowedTools', options.allowedTools || 'Read,Bash,Glob',
    '--no-session-persistence'
  ];

  if (options.maxBudget) {
    args.push('--max-budget-usd', options.maxBudget);
  }

  const result = execSync(`claude ${args.join(' ')}`, {
    encoding: 'utf8',
    cwd: options.cwd,
    timeout: options.timeout || 120000
  });

  return JSON.parse(result);
}

test('skill invocation returns expected structure', () => {
  const result = invokeClaude('check my todos', {
    cwd: '/tmp/test-project'
  });

  assert.strictEqual(result.type, 'result');
  assert.strictEqual(result.is_error, false);
  assert.ok(result.num_turns > 0, 'Should have at least one turn');
});
```

### Pattern 2: Test Isolation with Temporary Directories
**What:** Create isolated test environments using mktemp
**When to use:** Any test that creates/modifies files
**Example:**
```javascript
// Source: https://www.putorius.net/mktemp-working-with-temporary-files.html
import { mkdtempSync, rmSync, cpSync } from 'node:fs';
import { tmpdir } from 'node:os';
import { join } from 'node:path';
import { test, beforeEach, afterEach } from 'node:test';

let testDir;

beforeEach(() => {
  // Create unique temp directory
  testDir = mkdtempSync(join(tmpdir(), 'kata-test-'));

  // Copy fixture files
  cpSync('./tests/harness/fixtures/kata-project', testDir, { recursive: true });
});

afterEach(() => {
  // Cleanup
  rmSync(testDir, { recursive: true, force: true });
});

test('add todo creates file in correct location', () => {
  invokeClaude('add todo: test item', { cwd: testDir });

  // Verify file exists
  const todos = readdirSync(join(testDir, '.planning/todos/pending'));
  assert.ok(todos.length > 0);
});
```

### Pattern 3: Skill Invocation Verification
**What:** Verify Claude correctly invoked a skill vs. ad-hoc response
**When to use:** Testing skill trigger detection
**Example:**
```javascript
// Source: Empirical testing of Claude CLI JSON output
test('skill triggers on natural language', () => {
  const result = invokeClaude('check my todos', { cwd: testDir });

  // Multi-turn indicates skill workflow executed
  assert.ok(result.num_turns > 1, 'Skill should execute multiple turns');

  // Result text should contain skill-specific markers
  assert.ok(
    result.result.includes('KATA >') ||
    result.result.includes('todo'),
    'Should show skill output markers'
  );
});
```

### Anti-Patterns to Avoid
- **Testing without isolation:** Never run tests in the real Kata project directory
- **Ignoring cost:** Always use `--max-budget-usd` to prevent runaway API costs
- **Interactive prompts:** Never use flags that require user input in tests
- **Hardcoded paths:** Always use temp directories or relative paths in fixtures

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| JSON output parsing | Custom regex/text parsing | `--output-format json` + JSON.parse | Claude CLI provides structured JSON natively |
| Test isolation | Manual directory management | mkdtempSync + cleanup | Race conditions, orphaned files |
| Parallel test execution | Custom scheduler | node:test built-in parallelism | Concurrency handled by test runner |
| Permission bypass | Interactive approval scripts | `--allowedTools` flag | Claude CLI handles tool approval natively |
| Session continuity | File-based state passing | `--continue` or `--resume` flags | Built into Claude CLI |

**Key insight:** The Claude CLI already provides most testing primitives (JSON output, tool control, session management). The harness is primarily a thin wrapper for invoking and asserting.

## Common Pitfalls

### Pitfall 1: Cost Runaway in Tests
**What goes wrong:** Tests make expensive API calls without limits
**Why it happens:** Forgetting budget flags, complex prompts triggering many turns
**How to avoid:** Always use `--max-budget-usd 1.00` (or lower) in test harness
**Warning signs:** Test suite takes unusually long, unexpected API bills

### Pitfall 2: Skill Not Triggering
**What goes wrong:** Claude responds directly instead of using skill
**Why it happens:** Prompt doesn't match skill trigger patterns, skills not installed
**How to avoid:**
1. Ensure skills installed to test environment via Kata installer
2. Use trigger phrases from skill descriptions
3. Check `num_turns` in output (skills typically have >1 turn)
**Warning signs:** `num_turns: 1`, response lacks skill-specific formatting

### Pitfall 3: Test Interference
**What goes wrong:** Tests modify shared state, causing flaky results
**Why it happens:** Tests running in actual project directory, parallel execution conflicts
**How to avoid:** Always create fresh temp directory per test
**Warning signs:** Tests pass individually but fail in suite, random failures

### Pitfall 4: Permission Prompts Hanging Tests
**What goes wrong:** CI hangs waiting for interactive approval
**Why it happens:** Missing `--allowedTools` flag or tool not in allowlist
**How to avoid:** Explicitly list all required tools: `--allowedTools "Read,Bash,Glob,Write,Edit"`
**Warning signs:** Test timeout without output

### Pitfall 5: JSON Schema Validation Failures
**What goes wrong:** `--json-schema` causes Claude to fail generating valid output
**Why it happens:** Schema too strict, Claude's response format varies
**How to avoid:** Use JSON output format without schema for verification, schema for structured extraction only
**Warning signs:** `is_error: true` in response, schema validation errors

## Code Examples

Verified patterns from official sources:

### Basic CLI Invocation
```bash
# Source: https://code.claude.com/docs/en/headless
# Non-interactive invocation with JSON output
claude -p "check my todos" \
  --output-format json \
  --allowedTools "Read,Bash,Glob" \
  --no-session-persistence
```

### JSON Output Structure
```json
// Source: Empirical testing 2026-01-20
{
  "type": "result",
  "subtype": "success",
  "is_error": false,
  "duration_ms": 37150,
  "duration_api_ms": 32448,
  "num_turns": 19,
  "result": "...(Claude's text response)...",
  "session_id": "uuid",
  "total_cost_usd": 0.25,
  "usage": {
    "input_tokens": 5,
    "output_tokens": 2118
  },
  "modelUsage": {
    "claude-opus-4-5-20251101": {...},
    "claude-haiku-4-5-20251001": {...}
  },
  "permission_denials": []
}
```

### Test File Template
```javascript
// Source: https://nodejs.org/api/test.html
import { describe, it, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert/strict';
import { mkdtempSync, rmSync, cpSync } from 'node:fs';
import { tmpdir } from 'node:os';
import { join } from 'node:path';
import { execSync } from 'node:child_process';

describe('kata-managing-todos skill', () => {
  let testDir;

  beforeEach(() => {
    testDir = mkdtempSync(join(tmpdir(), 'kata-test-'));
    cpSync('./tests/fixtures/kata-project', testDir, { recursive: true });
  });

  afterEach(() => {
    rmSync(testDir, { recursive: true, force: true });
  });

  it('triggers on "check todos" prompt', () => {
    const output = execSync(
      'claude -p "check my todos" --output-format json --allowedTools "Read,Bash,Glob" --no-session-persistence --max-budget-usd 1.00',
      { cwd: testDir, encoding: 'utf8', timeout: 120000 }
    );

    const result = JSON.parse(output);

    assert.equal(result.type, 'result');
    assert.equal(result.is_error, false);
    assert.ok(result.num_turns > 1, 'Skill should execute multiple turns');
  });
});
```

### CI-Safe Invocation
```bash
# Source: https://code.claude.com/docs/en/headless
# For CI environments with sandboxing
claude -p "your prompt" \
  --output-format json \
  --allowedTools "Read,Bash,Glob,Write,Edit" \
  --no-session-persistence \
  --max-budget-usd 5.00 \
  --dangerously-skip-permissions  # Only in sandboxed CI
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| "headless mode" terminology | `-p` / `--print` flag | 2025 | Same functionality, clearer naming |
| Manual permission handling | `--allowedTools` flag | 2025 | Declarative tool approval in CLI |
| Text output parsing | `--output-format json` | 2025 | Structured output for automation |
| No cost controls | `--max-budget-usd` flag | 2025 | API cost limits for testing |

**Deprecated/outdated:**
- "headless mode" terminology: Now called "print mode" or "programmatic mode"
- Interactive permission flows in CI: Use `--allowedTools` or `--dangerously-skip-permissions`

## Open Questions

Things that couldn't be fully resolved:

1. **Skill file loading verification**
   - What we know: Skills are loaded from `~/.claude/skills/` or `.claude/skills/`
   - What's unclear: No CLI flag to verify which skills are loaded
   - Recommendation: Verify skill installation by checking file existence before tests

2. **Structured output for skill results**
   - What we know: `--json-schema` enables structured output validation
   - What's unclear: Whether skill-generated output can be constrained by schema
   - Recommendation: Use JSON output without schema, parse result text for assertions

3. **Model selection for tests**
   - What we know: `--model` flag allows specifying model
   - What's unclear: Cost/speed tradeoffs for test execution
   - Recommendation: Consider using Haiku for fast/cheap tests, Opus for behavior verification

4. **Session persistence impact**
   - What we know: `--no-session-persistence` prevents session saving
   - What's unclear: Whether this affects skill behavior
   - Recommendation: Use `--no-session-persistence` for isolation, test with persistence separately

## Sources

### Primary (HIGH confidence)
- [Claude Code Docs - Headless/Programmatic](https://code.claude.com/docs/en/headless) - CLI flags, output formats, session management
- [Node.js Test Runner Documentation](https://nodejs.org/api/test.html) - Native test runner API
- Empirical testing of Claude CLI (2026-01-20) - JSON output structure, skill invocation behavior

### Secondary (MEDIUM confidence)
- [Anthropic Engineering Blog - Claude Code Best Practices](https://www.anthropic.com/engineering/claude-code-best-practices) - Automation patterns
- [GitHub anthropics/claude-code-action](https://github.com/anthropics/claude-code-action) - CI/CD integration patterns
- [claude-code-is-programmable](https://github.com/disler/claude-code-is-programmable) - Community patterns

### Tertiary (LOW confidence)
- Various blog posts on LLM evaluation harnesses - General patterns, not Claude-specific

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Node.js built-ins are stable, CLI flags verified empirically
- Architecture: HIGH - Patterns derived from official docs and empirical testing
- Pitfalls: HIGH - Discovered through actual CLI testing
- Cost control: MEDIUM - Budget flag exists but exact behavior under limits unclear

**Research date:** 2026-01-20
**Valid until:** 60 days (Claude CLI is stable, patterns unlikely to change significantly)
